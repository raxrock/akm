# Incident Report: Order Service Outage

**Incident ID:** INC-2024-0318-001
**Severity:** P1 (Critical)
**Duration:** 45 minutes
**Date:** March 18, 2024

## Summary

The Order Service experienced a complete outage affecting all order creation and retrieval operations. Approximately 2,500 customers were impacted, resulting in failed checkout attempts.

## Timeline (All times in PST)

| Time | Event |
|------|-------|
| 14:20 | Increased error rate detected by monitoring |
| 14:23 | PagerDuty alert triggered |
| 14:25 | Error rate exceeds 50%, automated alert escalation |
| 14:28 | On-call engineer Alex Johnson acknowledges alert |
| 14:30 | Alex begins investigation, joins incident Slack channel |
| 14:32 | Sarah Chen (Platform Lead) joins as Incident Commander |
| 14:35 | Root cause identified: MongoDB connection pool exhausted |
| 14:40 | Mitigation plan: Increase connection pool size |
| 14:45 | Fix deployed to staging for validation |
| 14:48 | Fix validated, deployment to production initiated |
| 14:52 | Fix deployed to production |
| 14:58 | Error rate decreasing, connections stabilizing |
| 15:08 | Service fully recovered, incident resolved |

## Root Cause Analysis

### Technical Details

The Order Service was creating new MongoDB connections for each request instead of reusing connections from the pool. This was caused by a code change in commit `abc123def` merged on March 15, 2024.

**Problematic Code:**
```python
# BAD: Creates new client for each request
async def get_order(order_id: str):
    client = AsyncIOMotorClient(settings.MONGODB_URI)
    db = client.orders_db
    return await db.orders.find_one({"_id": order_id})
```

**Correct Code:**
```python
# GOOD: Reuses connection pool
client = AsyncIOMotorClient(settings.MONGODB_URI)
db = client.orders_db

async def get_order(order_id: str):
    return await db.orders.find_one({"_id": order_id})
```

### Contributing Factors

1. **Code Review Gap:** The change was reviewed but the connection handling issue was missed
2. **Test Coverage:** No integration test for connection pool behavior
3. **Monitoring Gap:** No alert for connection pool exhaustion

### Why It Wasn't Caught Earlier

- The issue only manifested under high load
- Staging environment has lower traffic, masking the problem
- The code change was merged during a low-traffic period

## Impact

### Customer Impact
- ~2,500 customers experienced checkout failures
- Estimated 1,200 abandoned carts
- Revenue impact: ~$45,000 in lost orders

### Technical Impact
- Order Service: 45 minutes downtime
- Inventory Service: 15 minutes degraded (dependency)
- API Gateway: Increased error responses

### Reputation Impact
- 47 customer support tickets
- 12 negative social media mentions
- 3 enterprise customer escalations

## Resolution

### Immediate Fix
- Increased MongoDB connection pool size from 10 to 100
- Reverted to singleton client pattern
- Deployed hotfix within 20 minutes of identification

### Verification
- Monitored connection pool metrics for 1 hour post-fix
- Verified order creation success rate returned to 99.9%
- Confirmed no data loss or corruption

## Action Items

| # | Action | Owner | Due Date | Status |
|---|--------|-------|----------|--------|
| 1 | Add connection pool monitoring | Alex Johnson | Mar 25 | Done |
| 2 | Create integration test for DB connections | Maria Garcia | Mar 27 | Done |
| 3 | Update code review checklist | Sarah Chen | Mar 22 | Done |
| 4 | Add load testing to CI/CD | John Smith | Apr 5 | In Progress |
| 5 | Document MongoDB best practices | David Lee | Apr 1 | In Progress |
| 6 | Customer communication | Support Team | Mar 19 | Done |

## Lessons Learned

### What Went Well
- Fast detection (3 minutes to alert)
- Quick root cause identification (7 minutes)
- Effective incident communication
- Clean rollback path available

### What Could Be Improved
- Connection pool monitoring should exist before incident
- Load testing should be part of CI/CD
- Code review should include infrastructure checklist

## Prevention Measures

1. **Automated Testing:** Add load tests that verify connection behavior
2. **Monitoring:** Add alerts for connection pool saturation
3. **Code Review:** Add database connection checklist
4. **Documentation:** Create MongoDB best practices guide

## Attendees

**Incident Response Team:**
- Sarah Chen (Incident Commander)
- Alex Johnson (On-Call Engineer)
- Maria Garcia (Backend Support)
- John Smith (Platform Support)

**Post-Incident Review:**
- All above plus Jennifer Walsh (Security review)

---

*Report prepared by: Alex Johnson*
*Reviewed by: Sarah Chen*
*Date: March 19, 2024*
